<!doctype html>
<html lang=en>
    <head>
        <meta charset=utf-8>

        <title>Random in PHP</title>
        
                <meta name=viewport content="width=device-width">
        
                <link rel=stylesheet href=/css/wouterj.css>
        <link href=http://fonts.googleapis.com/css?family=Ubuntu+Mono|Roboto+Slab:700|Open+Sans:300italic,300,700 rel=stylesheet type=text/css>
                
        <!-- Prettifier -->
<script src="/libs/prettifier/google-code-prettify/prettify.js"></script>
<link rel=stylesheet href="/libs/prettifier/prettifier.css">
<script>
    window.onload = function() {
        prettyPrint();
    };
</script>
    </head>
    <body class=page itemscope itemtype="http://schema.org/WebPage">
        <header class=page__header>

            <hgroup class=page__headline>
                <h1 class="hN  site-title" itemprop="name"><a href="/">Wouter J</a></h1>
                                <h3 class="hN  site-slogan">A script is more than just code</h3>
                            </hgroup>

            <nav class=page__nav>
                <ul class="nav  nav--block">
                                                            <li class="nav__item"><a href="/">Home</a></li>
                                        <li class="nav__item"><a href="/categories/article"><i class=icon>&#xF139;</i> <span class="button__text">Articles</span></a></li>
                                        <li class="nav__item"><a href="/categories/news"><i class=icon>&#xF0CA;</i> <span class="button__text">News</span></a></li>
                                        <li class="nav__item"><a href="/categories/opinion"><i class=icon>&#xF075;</i> <span class="button__text">Opinions</span></a></li>
                                        <li class="nav__item"><a href="/categories/experiment"><i class=icon>&#xF051;</i> <span class="button__text">Experiments</span></a></li>
                                    </ul>
            </nav>
        </header>

        <div class=page__body itemscope itemtype="http://schema.org/Blog">
            <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <span class="post__category">
            &#xf139;
        </span>    <h1 class="post__heading" itemprop="headline">Random in PHP</h1>

    
    <div class="post__entry" itemprop="articleBody">
        <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><p class="post__intro">Een computer is logisch, hoe kan zo'n logisch apparaat nou random getallen
maken? Vandaag nemen we een kijk in de PHP source om te kijken hoe het in PHP
gedaan wordt.</p><div class="cf"></div>

<h2 id="de-php-source"><a href="#de-php-source" class="section-link">&#61544;</a>De PHP source</h2>

<p>De PHP source is geschreven in C en je kunt een hele makkelijk navigeerbare
weergave van de source op http://lxr.php.net/ vinden. Hier kun je zoeken naar
functies en makkelijk naar de source van functies navigeren.</p>

<p>Er is 1 basis conceptje die ik moet vertellen, de rest zal je gaanderweg wel
gaan begrijpen. Dit concept is defines in C. De C taal wordt eerst gecompiled
en vervolgens wordt die compiled code omgezet in uitvoerbare code. Tijdens het
compilen kun je wat dingen doe die PHP niet kan. Bijv. het gebruik van
defines. Defines zijn woorden die worden omgezet in de waarde die je er aan
meegeeft. Laten we beginnen met een simpele constante:</p>

<pre class="prettyprint  linenums"><code>#define M_PI 3.14159265358979323846
</code></pre>

<p>Wanneer we nu in onze code <code>M_PI</code> gebruiken wordt dit vervangen door dit
getal:</p>

<pre class="prettyprint  linenums"><code>long omtrek = M_PI * 4;
</code></pre>

<p>Hier staat na het compilen eigenlijk:</p>

<pre class="prettyprint  linenums"><code>long omtrek = 3.14159265358979323846 * 4;
</code></pre>

<p>Naast het invullen van getallen of strings kun je ook macro's defini&Atilde;&laquo;ren.
Bijvoorbeeld deze macro:</p>

<pre class="prettyprint  linenums"><code>#define INCREMENT(x) x++
</code></pre>

<p>Nu zal <code>INCREMENT(5)</code> worden omgezet in <code>6</code>.</p>

<h2 id="random-getallen"><a href="#random-getallen" class="section-link">&#61544;</a>Random getallen</h2>

<p>De andere basis kennis is het doorhebben hoe je random getallen maakt. Random
getallen zijn eigenlijk een sequence, je begint met een getal en stopt die in
een formule. Uit deze formule komt een getal, dit getal is het random getal en
die wordt opgeslagen in een variabele (dezelfde variabele als het begin
getal). Dit getal wordt dan weer gebruikt om met dezelfde functie weer een
getal te genereren, die ook weer wordt opgeslagen en als je de functie nog een
keer aanroept komt er weer een ander getal uit.</p>

<p>Je zal wel begrijpen dat je dan een hele rij van allemaal nieuwe random
getallen krijgt. Wanneer je met hetzelfde getal begint zal er altijd dezelfde
rij uitkomen. Dit eerste getal noemen we een <em>seed</em>. De seed wordt random
gecree&Atilde;&laquo;rd, bijvoorbeeld door de tijd en datum te gebruiken. Op deze manier heb
je dus nooit dezelfde random reeks getallen.</p>

<h2 id="de-rand-functie"><a href="#de-rand-functie" class="section-link">&#61544;</a>De <code>rand</code> functie</h2>

<p>Nu je de basiskennis hebt gaan we kijken in de PHP source code. De meeste
functies worden aangemaakt door <code>PHP_FUNCTION(rand)</code>. Als we opzoek willen
naar de <code>rand</code> functie zoeken we op <code>"PHP_FUNCTION rand"</code> (vergeet de quotes
niet). In de <a href="http://lxr.php.net/search?q=%22PHP_FUNCTION+rand%22&amp;defs=&amp;refs=&amp;path=&amp;hist=&amp;project=PHP_5_4">resultaten</a> krijgen we dan 2 bestanden: <code>php_math.h</code> en
<code>rand.c</code>. De <code>*.h</code> bestanden zijn header bestanden, die vertellen wat er
allemaal in de <code>*.c</code> bestanden staat. De <code>*.c</code> bestanden bevatten de echte
code. We klikken dus op die link en navigeren naar <a href="http://lxr.php.net/xref/PHP_5_4/ext/standard/rand.c#290">regel 290</a>:</p>

<pre class="prettyprint  linenums"><code>PHP_FUNCTION(rand)
{
    long min;
    long max;
    long number;
    int  argc = ZEND_NUM_ARGS();

    if (argc != 0 &amp;&amp; zend_parse_parameters(argc TSRMLS_CC, "ll", &amp;min, &amp;max) == FAILURE)
        return;

    number = php_rand(TSRMLS_C);
    if (argc == 2) {
        RAND_RANGE(number, min, max, PHP_RAND_MAX);
    }

    RETURN_LONG(number);
}
</code></pre>

<p>En dat is de functie!</p>

<h3 id="parsen-van-argumenten"><a href="#parsen-van-argumenten" class="section-link">&#61544;</a>Parsen van argumenten</h3>

<p>Als eerst zien we dat er 4 variabelen gedeclareerd worden:</p>

<pre class="prettyprint  linenums"><code>long min;
long max;
long number;
int  argc = ZEND_NUM_ARGS();
</code></pre>

<p>De eerste 3 variabelen zijn of argumenten of variabele die we verder in de
functie gaan gebruiken. De 4e variabele, <code>argc</code>, is het aantal argumenten.
Zend is de engine achter PHP en we kunnen wel raden wat <code>ZEND_NUM_ARGS()</code>
doet, we gaan dus niet naar die source code kijken.</p>

<p>Dan krijgen we een check voor de argumenten:</p>

<pre class="prettyprint  linenums"><code>if (argc != 0 &amp;&amp; zend_parse_parameters(argc TSRMLS_CC, "ll", &amp;min, &amp;max) == FAILURE)
    return;
</code></pre>

<p>De check <code>argc != 0</code> betekend dat we pas argumenten gaan checken als er
argumenten zijn, dit komt omdat de <code>rand</code> functie ook zonder argumenten
aangeroepen kan worden. Zodra er wel argumenten zijn moeten er meteen 2 zijn.
Met <code>zend_parse_parameters</code> parsen we de argumenten. We zien <code>"ll"</code>, dit
betekend dat beide argumenten <code>long</code> (een soort float) zijn. Daarachter zien
we <code>&amp;min</code> en <code>&amp;max</code>, dit betekend dat de waarde van de argumenten worden mee
gegeven aan de variabelen <code>min</code> en <code>max</code> (die we hiervoor al gedeclareerd
hadden).</p>

<h3 id="het-maken-van-de-seed"><a href="#het-maken-van-de-seed" class="section-link">&#61544;</a>Het maken van de seed</h3>

<p>Dan gaan we de seed maken:</p>

<pre class="prettyprint  linenums"><code>number = php_rand(TSRMLS_C);
</code></pre>

<p>In deze regel roepen we de functie <code>php_rand</code> (een interne functie die niet in
PHP bestaat) aan. Die geven we ook weer een waarde mee, die is voor nu even
niet interessant.</p>

<p>Wat wel interessant is hoe PHP die random seed maakt. Dus klikken we op de
functie <code>php_rand</code> om die source te bekijken:</p>

<pre class="prettyprint  linenums"><code>PHPAPI long php_rand(TSRMLS_D)
{
    long ret;

    if (!BG(rand_is_seeded)) {
        php_srand(GENERATE_SEED() TSRMLS_CC);
    }

#ifdef ZTS
    ret = php_rand_r(&amp;BG(rand_seed));
#else
# if defined(HAVE_RANDOM)
    ret = random();
# elif defined(HAVE_LRAND48)
    ret = lrand48();
# else
    ret = rand();
# endif
#endif

    return ret;
}
</code></pre>

<p>Wat we hier heel in het kort zien is dat de functie, afhankelijk van bepaalde
instellingen, de C functies <code>rand</code>, <code>lrand48</code> of <code>random</code> gebruikt.</p>

<h3 id="het-maken-van-het-random-getal"><a href="#het-maken-van-het-random-getal" class="section-link">&#61544;</a>Het maken van het random getal</h3>

<pre class="prettyprint  linenums"><code>if (argc == 2) {
    RAND_RANGE(number, min, max, PHP_RAND_MAX);
}
</code></pre>

<p>Zodra er 2 argumenten zijn gegeven wordt de <code>RAND_RANGE</code> define functie
gebruikt om het random nummer tussen 2 waardes te maken. Zodra je dus geen
argumenten geeft, krijg je gewoon de seed terug.</p>

<p>Nu zijn we natuurlijk benieuwd wat voor algoritme PHP gebruikt voor het maken
van het random getal, dus klikken we erop en gaan we naar een
<a href="http://lxr.php.net/xref/PHP_5_4/ext/standard/php_rand.h#43"><code>php_rand.h</code></a> bestand:</p>

<pre class="prettyprint  linenums"><code>#define RAND_RANGE(__n, __min, __max, __tmax) \
    (__n) = (__min) + (long) ((double) ( (double) (__max) - (__min) + 1.0) * ((__n) / ((__tmax) + 1.0)))
</code></pre>

<p>En dat is de magische formule achter PHP's <code>rand</code> functie! Er wordt mooi
gespeelt met wat afronden (de <code>(long)</code>'s en <code>(double)</code>'s in de code), de min
en max (<code>__min</code> en <code>__max</code>) worden een paar keer gebruikt en ook onze seed
(<code>__n</code>) wordt gebruikt. Vervolgens zien we ook <code>(__n) = ...</code>, waardoor onze
seed dus weer vernieuwd wordt door het gegenereerde random getal.</p>

<h3 id="het-returnen-van-het-getal"><a href="#het-returnen-van-het-getal" class="section-link">&#61544;</a>Het returnen van het getal</h3>

<p>Het enige dat ons nog rest is het returnen van de gemaakt <code>long</code>:</p>

<pre class="prettyprint  linenums"><code>RETURN_LONG(number);
</code></pre>

<p>Achter deze simpele regel zit weer heel wat zend gedoe, maar daar bemoeien we
ons vandaag niet mee.</p>

<h2 id="dus"><a href="#dus" class="section-link">&#61544;</a>Dus...</h2>

<p>Je hoofd duizeld nu van de C code, maar je hebt wel begrepen hoe je kan kijken
hoe PHP functies werken. Ook heb je geleerd dat een goede random functie 4
factoren heeft: Niet voorspelbaar; geen herhalend patroon; alle getallen
moeten ongeveer gelijk voorkomen; dezelfde seed zorgt voor dezelfde rij random
getallen.</p></body></html>

    </div>

        <div id="disqus_thread" class="post__comments" itemprop="comment"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'wouterjnl'; // required: replace example with your forum shortname
        var disqus_identifier = '1379980800';
        var disqus_title = 'Random in PHP';
        var disqus_developer = 1;

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </article>
        </div>

        <footer class="page__footer">
            <p>&copy; Copyright 2012 Wouter de Jong</p>
        </footer>

                <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-30226315-1']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
        </script>
            </body>
</html>
